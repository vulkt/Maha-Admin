<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LC Details - Letter of Credit Management</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDwdlfBZWbNVFsj3ttfS9lcVJphIsFkKmA",
        authDomain: "tex1-e6595.firebaseapp.com",
        projectId: "tex1-e6595",
        storageBucket: "tex1-e6595.firebasestorage.app",
        messagingSenderId: "535507700855",
        appId: "1:535507700855:web:68f395bb2b3f7df52f4a72",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      let lcDocRef;

      async function loadLCDetails() {
        const selectedLC = localStorage.getItem("selectedLC");
        if (!selectedLC) {
          alert("No LC found in storage!");
          return;
        }

        lcDocRef = doc(db, "maha/LC/LC#", selectedLC, "Details", "LC-Info");
        const lcSnap = await getDoc(lcDocRef);

        if (!lcSnap.exists()) {
          alert("LC not found in Firestore");
          return;
        }

        const lcData = lcSnap.data();

        // Fill inputs instead of divs
        document.getElementById("lcNumber").value = lcData["LC-NO"] || selectedLC;
        document.getElementById("lcValue").value = lcData["LC-Value"] || "";
        document.getElementById("downPayment").value = lcData["Down-Payment"] || "";
        document.getElementById("lcBalance").value = lcData["LC-Balance"] || "";
        document.getElementById("lcUtilized").value = lcData["LC-Utilized"] || "";
        document.getElementById("issueDate").value = lcData["Issue-Date"] ? formatDateInput(lcData["Issue-Date"]) : "";
        document.getElementById("expireDate").value = lcData["Expire-Date"] ? formatDateInput(lcData["Expire-Date"]) : "";
        document.getElementById("paymentTerm").value = lcData["Payment-Term"] || "";
        document.getElementById("bank").value = lcData["Bank"] || "";
        document.getElementById("status").value = lcData["Status"] || "";
        document.getElementById("lastShipmentDate").value = lcData["Last-Shipment-Date"] ? formatDateInput(lcData["Last-Shipment-Date"]) : "";

        // ----------------------------
        // Load Shipments
        // ----------------------------
        const tbody = document.getElementById("shipmentTableBody");
        tbody.innerHTML = "";
        let totalExpected = 0;

        if (lcData.shipments && Array.isArray(lcData.shipments)) {
          lcData.shipments.forEach((s, index) => {
            totalExpected += s["Expected-Amount"] || 0;

            const row = document.createElement("tr");
            row.className = "hover:bg-gray-50 transition-colors cursor-pointer";

            // Make the row clickable
            row.onclick = () => {
              localStorage.setItem("selectedShipment", JSON.stringify(s));
              window.location.href = "Shipment-Admin.html";
            };

            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-black">
                ${s["Shipment-Date"] ? new Date(s["Shipment-Date"].seconds * 1000).toLocaleDateString() : "—"}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${s["Payment-Terms"] || "—"}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${s["Status"] || "—"}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-black">${s["Expected-Amount"] !== undefined ? s["Expected-Amount"].toFixed(2) : "—"}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${s["Expected-Date"] ? new Date(s["Expected-Date"].seconds * 1000).toLocaleDateString() : "—"}</td>
            `;
            tbody.appendChild(row);
          });

          document.getElementById("shipmentCount").innerText = `Showing ${lcData.shipments.length} shipments`;
          document.getElementById("totalInvoice").innerText = `Total Expected: ${totalExpected.toFixed(2)}`;
        } else {
          tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No shipments found</td></tr>`;
          document.getElementById("shipmentCount").innerText = "No shipments";
          document.getElementById("totalInvoice").innerText = "—";
        }
      }

      function formatDateInput(value) {
        try {
          let date = value.toDate ? value.toDate() : new Date(value);
          return date.toISOString().split("T")[0];
        } catch {
          return "";
        }
      }

      function formatDate(value) {
        if (!value) return "—";
        try {
          let date = value.toDate ? value.toDate() : new Date(value);
          return date.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
        } catch {
          return "—";
        }
      }

      function formatCurrency(value) {
        if (!value) return "—";
        return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(value);
      }

      function formatPercentage(value) {
        if (!value) return "—";
        return `${value}%`;
      }

      async function saveLCDetails() {
        if (!lcDocRef) {
          alert("No LC document reference found!");
          return;
        }

        const updatedData = {
          "LC-NO": document.getElementById("lcNumber").value,
          "LC-Value": parseFloat(document.getElementById("lcValue").value) || 0,
          "Down-Payment": parseFloat(document.getElementById("downPayment").value) || 0,
          "LC-Balance": parseFloat(document.getElementById("lcBalance").value) || 0,
          "LC-Utilized": parseFloat(document.getElementById("lcUtilized").value) || 0,
          "Issue-Date": new Date(document.getElementById("issueDate").value),
          "Expire-Date": new Date(document.getElementById("expireDate").value),
          "Payment-Term": document.getElementById("paymentTerm").value,
          "Bank": document.getElementById("bank").value,
          "Status": document.getElementById("status").value,
          "Last-Shipment-Date": new Date(document.getElementById("lastShipmentDate").value),
        };

        await updateDoc(lcDocRef, updatedData);
        alert("LC details updated successfully!");
      }

      document.addEventListener("DOMContentLoaded", loadLCDetails);
      window.saveLCDetails = saveLCDetails;
    </script>
  </head>
  <body class="bg-white min-h-screen">
    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
          <button onclick="window.history.back()" class="flex items-center justify-center w-10 h-10 text-gray-600 hover:text-primary transition-colors">←</button>
          <h1 class="text-2xl font-bold text-black">Letter of Credit Details</h1>
        </div>
      </div>

      <div class="space-y-8">
        <!-- General Information -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-black">General Information</h2>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">LC Number</label>
                  <input id="lcNumber" class="w-full border rounded p-2 text-black" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">LC Value</label>
                  <input id="lcValue" type="number" class="w-full border rounded p-2 text-black" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Down Payment</label>
                  <input id="downPayment" type="number" class="w-full border rounded p-2 text-black" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">LC Balance</label>
                  <input id="lcBalance" type="number" class="w-full border rounded p-2 text-black" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">LC Utilized</label>
                  <input id="lcUtilized" type="number" class="w-full border rounded p-2 text-black" />
                </div>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Issue Date</label>
                  <input id="issueDate" type="date" class="w-full border rounded p-2 text-black" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Expire Date</label>
                  <input id="expireDate" type="date" class="w-full border rounded p-2 text-black" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Payment Term</label>
                  <input id="paymentTerm" class="w-full border rounded p-2 text-black" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Bank</label>
                    <select id="bank" class="w-full border rounded p-2 text-black">
                      <option value="">Select bank</option>
                      <option value="Alinma bank" ${shipment["Bank"] === "Alinma bank" ? "selected" : ""}>Alinma bank</option>
                      <option value="ANB" ${shipment["Bank"] === "ANB" ? "selected" : ""}>ANB</option>
                    </select>
                  </div>
                  
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                    <select id="status" class="w-full border rounded p-2 text-black">
                      <option value="">Select status</option>
                      <option value="Active">Active</option>
                      <option value="Expired">Expired</option>
                      <option value="Pinned">Pinned</option>
                    </select>
                  </div>
                  
              </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Last Shipment Date</label>
                <input id="lastShipmentDate" type="date" class="w-full border rounded p-2 text-black" />
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
<div class="flex justify-end items-center pt-6">
    <div class="flex gap-3">
      <!-- Save Changes button -->
      <button onclick="saveLCDetails()" 
        class="px-6 py-2 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
        Save Changes
      </button>
  
      <!-- Submit button -->
      <button type="submit" onclick="saveLCDetails()" 
        class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
        Submit
      </button>
  
      
    </div>
  </div>

        <!-- Shipments -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-black">Shipment & Payment Details</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Shipment Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Payment Terms</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Expected Amount</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Expected Payment Date</th>
                </tr>
              </thead>
              <tbody id="shipmentTableBody" class="bg-white divide-y divide-gray-200">
                <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="bg-gray-50 px-6 py-3 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div id="shipmentCount" class="text-sm text-gray-600">—</div>
              <div id="totalInvoice" class="text-sm font-medium text-black">—</div>
            </div>
          </div>
        </div>

  
      </div>
    </div>
  </body>
</html>
